# <a name="integrate-microsoft-graph-security-api-alerts-with-your-siem-using-azure-monitor"></a><span data-ttu-id="0df28-101">Integração dos alertas da API de segurança do Microsoft Graph com seu SIEM usando o Azure Monitor</span><span class="sxs-lookup"><span data-stu-id="0df28-101">Integrate security API alerts with your SIEM using Azure Monitor</span></span>

<span data-ttu-id="0df28-102">Os provedores de segurança do Microsoft Graph podem ser gerenciados por meio de um único ponto de extremidade REST.</span><span class="sxs-lookup"><span data-stu-id="0df28-102">The Microsoft Graph Security providers can be managed through a single REST endpoint.</span></span> <span data-ttu-id="0df28-103">Esse ponto de extremidade pode ser configurado para o [Azure Monitor](https://docs.microsoft.com/en-us/azure/monitoring-and-diagnostics/) que suporta conectores para vários produtos SIEM.</span><span class="sxs-lookup"><span data-stu-id="0df28-103">This endpoint can be configured to [Azure Monitor](https://docs.microsoft.com/en-us/azure/monitoring-and-diagnostics/) which supports connectors to several SIEM products.</span></span> <span data-ttu-id="0df28-104">As instruções nas etapas 1 e 2 deste artigo se referem a todos os conectores do Azure Monitor que suportam o consumo pelo hub de eventos.</span><span class="sxs-lookup"><span data-stu-id="0df28-104">The instructions in Steps 1 and 2 of this article refer to all Azure Monitor connectors that support consumption via event hubs.</span></span> <span data-ttu-id="0df28-105">Este artigo descreve a integração de ponta a ponta do conector [Splunk](https://splunkbase.splunk.com/) SIEM.</span><span class="sxs-lookup"><span data-stu-id="0df28-105">This article describes the end-to-end configuration for the Splunk SIEM connector.</span></span>

<span data-ttu-id="0df28-106">O processo de integração envolve as seguintes etapas:</span><span class="sxs-lookup"><span data-stu-id="0df28-106">The integration process involves the following steps:</span></span>

1. [<span data-ttu-id="0df28-107">Configurar o Azure como hub de eventos para receber alertas de segurança para o locatário</span><span class="sxs-lookup"><span data-stu-id="0df28-107">Set up Azure your event hub to receive security alerts for your tenant</span></span>](#step-1-set-up-an-event-hubs-namespace-in-azure-to-receive-security-alerts-for-your-tenant)
2. [<span data-ttu-id="0df28-108">Configurar o Azure Monitor para enviar alertas de segurança do locatário para o hub de eventos</span><span class="sxs-lookup"><span data-stu-id="0df28-108">Configure Azure Monitor to send security alerts from your tenant to the event hub</span></span>](#step-2-configure-azure-monitor-to-send-security-alerts-from-your-tenant-to-the-event-hub)
3. [<span data-ttu-id="0df28-109">Baixar e instalar o complemento do Azure Monitor para o Splunk permitindo a este consumir alertas de segurança</span><span class="sxs-lookup"><span data-stu-id="0df28-109">Download and install the Azure Monitor Add-on for Splunk which will allow Splunk to consume security alerts</span></span>](#step-3-download-and-install-the-azure-monitor-add-on-for-splunk-which-will-allow-splunk-to-consume-security-alerts)
4. [<span data-ttu-id="0df28-110">Registrar um aplicativo com o locatário do Azure Active Directory que o Splunk usará para fazer leitura no hub de eventos</span><span class="sxs-lookup"><span data-stu-id="0df28-110">Register an application with your tenant Azure Active Directory which Splunk will use to read from the event hub</span></span>](#step-4-register-an-application-with-your-tenant-azure-active-directory-which-splunk-will-use-to-read-from-the-event-hub )
5. [<span data-ttu-id="0df28-111">Criar um Azure Key Vault para armazenar a tecla de acesso do hub de eventos</span><span class="sxs-lookup"><span data-stu-id="0df28-111">Create an Azure Key vault to store the access key for the event hub</span></span>](#step-5-create-an-azure-key-vault-to-store-the-access-key-for-the-event-hub)
6. [<span data-ttu-id="0df28-112">Configurar as entradas de dados do Splunk para consumir alertas de segurança armazenados no hub de eventos</span><span class="sxs-lookup"><span data-stu-id="0df28-112">Configure the Splunk data inputs to consume security alerts stored in the event hub</span></span>](#step-6-configure-the-splunk-data-inputs-to-consume-security-alerts-stored-in-the-event-hub)

<span data-ttu-id="0df28-113">Após a conclusão dessas etapas, o Splunk Enterprise consumirá alertas de segurança de todos os produtos de segurança integrados ao Microsoft Graph para os quais seu locatário está licenciado.</span><span class="sxs-lookup"><span data-stu-id="0df28-113">After you complete these steps, your Splunk Enterprise will consume security alerts from all the Microsoft Graph integrated security products for which your tenant is licensed.</span></span> <span data-ttu-id="0df28-114">Todos os novos produtos de segurança que você licenciar também enviarão alertas por essa conexão, no mesmo esquema sem qualquer trabalho de integração adicional necessário.</span><span class="sxs-lookup"><span data-stu-id="0df28-114">Any new security products that you license will also send alerts through this connection, in the same schema with no further integration work needed.</span></span>

## <a name="step-1-set-up-an-event-hubs-namespace-in-azure-to-receive-security-alerts-for-your-tenant"></a><span data-ttu-id="0df28-115">Etapa 1: Configurar um namespace para o Hub de Eventos no Azure para receber alertas de segurança do locatário</span><span class="sxs-lookup"><span data-stu-id="0df28-115">Step 1: Set up an Event Hubs namespace in Azure to receive security alerts for your tenant</span></span>

<span data-ttu-id="0df28-116">Para começar, você precisa criar um namespace e um hub de eventos para o [Hub de Eventos do Microsoft Azure](https://docs.microsoft.com/en-us/azure/event-hubs/).</span><span class="sxs-lookup"><span data-stu-id="0df28-116">To begin, you need to create a Microsoft Azure Event Hubs namespace and event hub.</span></span> <span data-ttu-id="0df28-117">Esse hub de eventos e namespace serão o destino de todos os alertas de segurança da organização.</span><span class="sxs-lookup"><span data-stu-id="0df28-117">This namespace and event hub is the destination for all your organization’s security alerts.</span></span> <span data-ttu-id="0df28-118">Um namespace do Hub de Eventos é um agrupamento lógico de hubs de eventos que compartilham a mesma política de acesso.</span><span class="sxs-lookup"><span data-stu-id="0df28-118">An Event Hubs namespace is a logical grouping of event hubs that share the same access policy.</span></span> <span data-ttu-id="0df28-119">Observe alguns detalhes importantes sobre o namespace e os hubs de eventos dos Hubs de Eventos criados por você:</span><span class="sxs-lookup"><span data-stu-id="0df28-119">Note a few details about the Event Hubs namespace and event hubs that you create:</span></span>

- <span data-ttu-id="0df28-120">É recomendável usar um namespace para os Hubs de Eventos Padrão, especialmente se você estiver enviando outros dados de monitoramento do Azure por esses mesmos hubs de eventos.</span><span class="sxs-lookup"><span data-stu-id="0df28-120">We recommend using a Standard Event Hubs namespace, particularly if you are sending other Azure monitoring data through these same event hubs.</span></span>
- <span data-ttu-id="0df28-121">Normalmente, apenas uma unidade de taxa de transferência é necessária.</span><span class="sxs-lookup"><span data-stu-id="0df28-121">Typically, only one throughput unit is necessary.</span></span> <span data-ttu-id="0df28-122">Se uma ampliação é necessária à medida que a utilização aumenta, é possível aumentar manualmente a quantidade de unidades de taxa de transferência do namespace posteriormente ou habilitar a inflação automática.</span><span class="sxs-lookup"><span data-stu-id="0df28-122">If you need to scale up as your usage increases, you can always manually increase the number of throughput units for the namespace later or enable auto inflation.</span></span>
- <span data-ttu-id="0df28-123">A quantidade de unidades de taxa de transferência permite aumentar a escala de produtividade dos hubs de eventos.</span><span class="sxs-lookup"><span data-stu-id="0df28-123">The number of throughput units allows you to increase throughput scale for your event hubs.</span></span> <span data-ttu-id="0df28-124">A quantidade de partições permite colocar em paralelo o consumo em vários clientes.</span><span class="sxs-lookup"><span data-stu-id="0df28-124">The number of partitions allows you to parallelize consumption across many consumers.</span></span> <span data-ttu-id="0df28-125">Uma única partição pode alcançar até 20 MB por segundo, ou aproximadamente 20 mil mensagens por segundo.</span><span class="sxs-lookup"><span data-stu-id="0df28-125">A single partition can do up to 20MBps, or approximately 20,000 messages per second.</span></span> <span data-ttu-id="0df28-126">Dependendo da ferramenta de consumo de dados, o consumo de várias partições pode ser compatível.</span><span class="sxs-lookup"><span data-stu-id="0df28-126">Depending on the tool consuming the data, it may or may not support consuming from multiple partitions.</span></span> <span data-ttu-id="0df28-127">Se você não tem certeza da quantidade de partições a definir, recomendamos começar com quatro partições.</span><span class="sxs-lookup"><span data-stu-id="0df28-127">If you're not sure about the number of partitions to set, we recommend starting with four partitions.</span></span>
- <span data-ttu-id="0df28-128">Recomendamos definir a retenção de mensagem no hub de eventos para sete dias.</span><span class="sxs-lookup"><span data-stu-id="0df28-128">We recommend that you set message retention on your event hub to 7 days.</span></span> <span data-ttu-id="0df28-129">Se a ferramenta de consumo falhar por mais de um dia, isso garantirá que ela poderá retomar de onde parou (para eventos de até 7 dias).</span><span class="sxs-lookup"><span data-stu-id="0df28-129">If your consuming tool goes down for more than a day, this ensures that the tool can pick up where it left off (for events up to 7 days old).</span></span>
- <span data-ttu-id="0df28-130">Recomendamos o uso do grupo de consumidores padrão para o hub de eventos.</span><span class="sxs-lookup"><span data-stu-id="0df28-130">We recommend using the default consumer group for your event hub.</span></span> <span data-ttu-id="0df28-131">Não é necessário criar outros grupos de consumidores ou usar um grupo de consumidores separado, a menos que você pretenda que duas ferramentas diferentes consumam os mesmos dados do mesmo hub de eventos.</span><span class="sxs-lookup"><span data-stu-id="0df28-131">You don't need to create other consumer groups or use a separate consumer group unless you plan to have two different tools consume the same data from the same event hub.</span></span>
- <span data-ttu-id="0df28-132">Normalmente, as portas 5671 e 5672 devem estar abertas no computador que consome os dados do hub de eventos.</span><span class="sxs-lookup"><span data-stu-id="0df28-132">Typically, port 5671 and 5672 must be opened on the machine consuming data from the event hub.</span></span>

<span data-ttu-id="0df28-133">Confira também as [Perguntas frequentes do Hub de Eventos do Azure](https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-faq).</span><span class="sxs-lookup"><span data-stu-id="0df28-133">Also see the [Azure Event Hubs FAQ](https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-faq).</span></span>

1. <span data-ttu-id="0df28-134">Faça logon no [portal do Azure](https://portal.azure.com/) e escolha **Criar um recurso** na parte superior esquerda da tela.</span><span class="sxs-lookup"><span data-stu-id="0df28-134">Log on to the [Azure portal](https://portal.azure.com/) and choose **Create a resource** at the top left of the screen.</span></span>

    ![Imagem de Criar um recurso](../concepts/images/create-resource.png)

2. <span data-ttu-id="0df28-136">Selecione **Internet das coisas** e **Hubs de Eventos**.</span><span class="sxs-lookup"><span data-stu-id="0df28-136">Select **Internet of Things** and choose **Event Hubs**.</span></span>

    ![imagem de Hubs de Eventos](../concepts/images/event-hubs.png)

3. <span data-ttu-id="0df28-138">Em **Criar um namespace**, insira um nome para o namespace.</span><span class="sxs-lookup"><span data-stu-id="0df28-138">In **Create namespace**, enter a namespace name.</span></span> <span data-ttu-id="0df28-139">Após confirmar que o nome do namespace está disponível, escolha a faixa de preço (Básico ou Padrão).</span><span class="sxs-lookup"><span data-stu-id="0df28-139">After making sure the namespace name is available, choose the pricing tier (Basic or Standard).</span></span> <span data-ttu-id="0df28-140">Escolha também uma assinatura do Azure, o grupo de recursos e o local no qual deseja criar o recurso.</span><span class="sxs-lookup"><span data-stu-id="0df28-140">Also, choose an Azure subscription, resource group, and location in which to create the resource.</span></span> <span data-ttu-id="0df28-141">Escolha **Criar** para criar o namespace.</span><span class="sxs-lookup"><span data-stu-id="0df28-141">Choose **Create** to create the namespace.</span></span> <span data-ttu-id="0df28-142">Pode ser preciso esperar alguns minutos para que o sistema provisione totalmente os recursos.</span><span class="sxs-lookup"><span data-stu-id="0df28-142">You might have to wait a few minutes for the system to fully provision the resources.</span></span>

    ![imagem de Criar um namespace](../concepts/images/create-namespace.png)

## <a name="step-2-configure-azure-monitor-to-send-security-alerts-from-your-tenant-to-the-event-hub"></a><span data-ttu-id="0df28-144">Etapa 2: configurar o Azure Monitor para enviar alertas de segurança do locatário para o hub de eventos</span><span class="sxs-lookup"><span data-stu-id="0df28-144">Step 2: Configure Azure Monitor to send security alerts from your tenant to the event hub</span></span>

<span data-ttu-id="0df28-145">A habilitação do streaming dos alertas de segurança da organização pelo Azure Monitor é feita uma vez para todo o locatário do Azure Active Directory (Azure AD).</span><span class="sxs-lookup"><span data-stu-id="0df28-145">Enabling the streaming of your organization’s security alerts through Azure Monitor is done one time for your entire Azure Active Directory (Azure AD) tenant.</span></span> <span data-ttu-id="0df28-146">Todos os produtos licenciados e habilitados para a API de segurança do Microsoft Graph começarão a enviar alertas de segurança ao Azure Monitor, fazendo o streaming de dados para aplicativos de consumo.</span><span class="sxs-lookup"><span data-stu-id="0df28-146">All security API licensed and enabled products will begin sending security alerts to Azure Monitor, streaming data to consuming applications.</span></span> <span data-ttu-id="0df28-147">Todos os produtos adicionais habilitados para a API de segurança do Microsoft Graph que a organização implantar e licenciar farão o streaming automático dos alertas de segurança pela mesma configuração do Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="0df28-147">Any additional security API-enabled products licensed and deployed by your organization will automatically stream security alerts through this same Azure Monitor configuration.</span></span> <span data-ttu-id="0df28-148">Nenhum trabalho adicional de integração é necessário por parte da organização.</span><span class="sxs-lookup"><span data-stu-id="0df28-148">No further integration work is needed from the organization.</span></span>

<span data-ttu-id="0df28-149">Os alertas de segurança são dados altamente privilegiados, normalmente visíveis apenas pelas equipes de resposta de segurança e administradores globais de uma organização.</span><span class="sxs-lookup"><span data-stu-id="0df28-149">Security alerts are highly privileged data typically viewable only by security response personnel and global administrators within an organization.</span></span> <span data-ttu-id="0df28-150">Por esse motivo, as etapas necessárias para configurar a integração dos alertas de segurança do locatário com os sistemas SIEM exigem uma conta de Administrador Global do Azure AD.</span><span class="sxs-lookup"><span data-stu-id="0df28-150">For this reason, the steps required to configure the integration of a tenant’s security alerts with SIEM systems require an Azure AD Global Administrator account.</span></span> <span data-ttu-id="0df28-151">Essa conta é necessária apenas uma vez, durante a instalação, para a solicitação de envio dos alertas de segurança da sua organização ao Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="0df28-151">This account is only needed one time, during setup, to request your organization’s security alerts be sent to Azure Monitor.</span></span>

> <span data-ttu-id="0df28-152">**Observação:** no momento, a folha de configurações do Azure Monitor Diagnostic não suporta a configuração de recursos no nível do locatário.</span><span class="sxs-lookup"><span data-stu-id="0df28-152">**Note:** At this time, the Azure Monitor Diagnostic settings blade does not allow configuration of tenant-level resources.</span></span> <span data-ttu-id="0df28-153">Os alertas da API de segurança do Microsoft Graph são um recurso de nível de locatário que requerem o uso da API do Gerenciador de Recursos do Azure para configurar o Azure Monitor para suportar o consumo de alertas de segurança da sua organização.</span><span class="sxs-lookup"><span data-stu-id="0df28-153">Microsoft Graph Security API alerts are a tenant-level resource, which requires using the Azure Resource Manager API to configure Azure Monitor to support consumption of your organization’s security alerts.</span></span>

1. <span data-ttu-id="0df28-154">Em sua assinatura do Azure, registre o "microsoft.insights" (Azure Monitor) como provedor do recursos.</span><span class="sxs-lookup"><span data-stu-id="0df28-154">In your Azure subscription, register "microsoft.insights" (Azure Monitor) as a resource provider.</span></span>  
> <span data-ttu-id="0df28-155">**Observação:** Não registre "Microsoft.SecurityGraph" (API de segurança do Microsoft Graph) como um provedor de recursos na sua assinatura do Azure, pois o "Microsoft.SecurityGraph" é um recurso no nível de locatário, como explicado acima.</span><span class="sxs-lookup"><span data-stu-id="0df28-155">**Note:** Do not register "Microsoft.SecurityGraph" (Microsoft Graph Security API) as a resource provider in your Azure subscription, as “Microsoft.SecurityGraph” is a tenant-level resource as explained above.</span></span> <span data-ttu-id="0df28-156">A configuração de nível de locatário fará parte do nº 6 abaixo.</span><span class="sxs-lookup"><span data-stu-id="0df28-156">Tenant level configuration will be part of #6 below.</span></span>

2. <span data-ttu-id="0df28-157">Para configurar o Azure Monitor usando a API Azure Resource Manager, obtenha a ferramenta [ARMClient](https://github.com/projectkudu/ARMClient).</span><span class="sxs-lookup"><span data-stu-id="0df28-157">To configure Azure Monitor using the Azure Resource Manager API, obtain the [ARMClient](https://github.com/projectkudu/ARMClient) tool.</span></span> <span data-ttu-id="0df28-158">Ela será usada para enviar chamadas da API REST para o portal do Azure de uma linha de comando.</span><span class="sxs-lookup"><span data-stu-id="0df28-158">This tool will be used to send REST API calls to the Azure portal from a command line.</span></span>

3. <span data-ttu-id="0df28-159">Prepare um arquivo JSON de solicitação de configuração de diagnóstico como este:</span><span class="sxs-lookup"><span data-stu-id="0df28-159">Prepare a diagnostic setting request JSON file like the following:</span></span>

    ``` json
    {
      "location": "",
      "properties": {
        "name": "securityApiAlerts",
        "serviceBusRuleId": "/subscriptions/SUBSCRIPTION_ID/resourceGroups/RESOURCE_GROUP/providers/Microsoft.EventHub/namespaces/EVENT_HUB_NAMESPACE/authorizationrules/RootManageSharedAccessKey",
        "logs": [
          {
            "category": "Alert",
            "enabled": true,
            "retentionPolicy": {
              "enabled": true,
              "days": 7
            }
          }
        ]
      }
    }
    ```

    <span data-ttu-id="0df28-160">Substitua os valores no arquivo JSON da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="0df28-160">Replace the values in the JSON file as follows:</span></span>

    <span data-ttu-id="0df28-161">**SUBSCRIPTION_ID** é a ID de assinatura do Azure que hospeda o grupo de recursos e o namespace do hub de eventos para onde você enviará os alertas de segurança da organização.</span><span class="sxs-lookup"><span data-stu-id="0df28-161">**SUBSCRIPTION_ID** is the Subscription ID of the Azure subscription hosting the resource group and event hub namespace where you will be sending security alerts from your organization.</span></span>

    <span data-ttu-id="0df28-162">**RESOURCE_GROUP** é o grupo de recursos que contém o namespace do hub de eventos para onde você enviará os alertas de segurança da organização.</span><span class="sxs-lookup"><span data-stu-id="0df28-162">**RESOURCE_GROUP** is the resource group containing the event hub namespace where you will be sending security alerts from your organization.</span></span>

    <span data-ttu-id="0df28-163">**EVENT_HUB_NAMESPACE** é o namespace do hub de eventos para onde você enviará os alertas de segurança da organização.</span><span class="sxs-lookup"><span data-stu-id="0df28-163">**EVENT_HUB_NAMESPACE** is the event hub namespace where you will be sending security alerts from your organization.</span></span>

    <span data-ttu-id="0df28-164">**"days":** é o número de dias pelos quais você deseja manter as mensagens no hub de eventos.</span><span class="sxs-lookup"><span data-stu-id="0df28-164">**“days”:** 7 is the number of days you want to retain messages in your event hub.</span></span>

4. <span data-ttu-id="0df28-165">Salve o arquivo como JSON no diretório onde você vai chamar o ARMClient.exe.</span><span class="sxs-lookup"><span data-stu-id="0df28-165">Save the file as JSON to the directory where you will invoke ARMClient.exe.</span></span> <span data-ttu-id="0df28-166">Por exemplo, chame o arquivo de **AzMonConfig.json.**</span><span class="sxs-lookup"><span data-stu-id="0df28-166">For example, name the file **AzMonConfig.json.**</span></span>

5. <span data-ttu-id="0df28-167">Execute o seguinte comando para entrar na ferramenta ARMClient.</span><span class="sxs-lookup"><span data-stu-id="0df28-167">Run the following command to sigh in to the ARMClient tool.</span></span> <span data-ttu-id="0df28-168">Você precisará usar credenciais da conta de Administrador Global.</span><span class="sxs-lookup"><span data-stu-id="0df28-168">You will need to be using Global Administrator account credentials.</span></span>

    ``` shell
    ARMClient.exe login
    ```

6. <span data-ttu-id="0df28-169">Execute o comando a seguir para configurar o envio de alertas de segurança pelo Azure Monitor para o namespace do hub de eventos.</span><span class="sxs-lookup"><span data-stu-id="0df28-169">Run the following command to configure Azure Monitor to send security alerts to your event hub namespace.</span></span> <span data-ttu-id="0df28-170">Isso provisionará automaticamente um hub de eventos no namespace e iniciará o fluxo de alertas de segurança no hub de eventos.</span><span class="sxs-lookup"><span data-stu-id="0df28-170">This will automatically provision an event hub within the namespace and start the flow of security alerts into the event hub.</span></span> <span data-ttu-id="0df28-171">O nome da configuração (neste exemplo, **securityApiAlerts**) deve corresponder ao nome da configuração especificado no arquivo JSON para o campo **name**.</span><span class="sxs-lookup"><span data-stu-id="0df28-171">Ensure that the setting name (in this example, **securityApiAlerts**) matches the setting name you specified in the JSON file for the **name** field.</span></span>

    ``` shell
    ARMClient.exe put https://management.azure.com/providers/Microsoft.SecurityGraph/diagnosticSettings/securityApiAlerts?api-version=2017-04-01-preview  @".\AzMonConfig.json"
    ```

7. <span data-ttu-id="0df28-172">Para verificar a aplicação correta das configurações, execute este comando e confirme que a saída corresponde às configurações do arquivo JSON.</span><span class="sxs-lookup"><span data-stu-id="0df28-172">To verify the settings were applied correctly, run this command and verify that the output matches your JSON file settings.</span></span>

    ``` shell
    ARMClient.exe get https://management.azure.com/providers/Microsoft.SecurityGraph/diagnosticSettings/securityApiAlerts?api-version=2017-04-01-preview
    ```
8. <span data-ttu-id="0df28-173">Saia da ferramenta ARMClient.</span><span class="sxs-lookup"><span data-stu-id="0df28-173">Exit the ARMClient tool.</span></span> <span data-ttu-id="0df28-174">Você concluiu a configuração do Azure Monitor para o envio de alertas de segurança do locatário para hub de eventos.</span><span class="sxs-lookup"><span data-stu-id="0df28-174">You have now completed the configuration of Azure Monitor to send security alerts from your tenant to event hub.</span></span>

## <a name="step-3-download-and-install-the-azure-monitor-add-on-for-splunk-which-will-allow-splunk-to-consume-security-alerts"></a><span data-ttu-id="0df28-175">Etapa 3: Baixar e instalar o complemento do Azure Monitor para o Splunk, o que permitirá que ele consuma alertas de segurança</span><span class="sxs-lookup"><span data-stu-id="0df28-175">Step 3: Download and install the Azure Monitor Add-on for Splunk which will allow Splunk to consume security alerts</span></span>

1. <span data-ttu-id="0df28-176">Essa integração só oferece suporte a implantações do [ Splunk Enterprise](https://splunkbase.splunk.com/)  .</span><span class="sxs-lookup"><span data-stu-id="0df28-176">This integration only supports Splunk Enterprise deployments.</span></span>
2. <span data-ttu-id="0df28-177">Baixe e instale o [complemento do Azure Monitor para o Splunk](https://github.com/Microsoft/AzureMonitorAddonForSplunk).</span><span class="sxs-lookup"><span data-stu-id="0df28-177">Download and install the [Azure Monitor Add-on for Splunk](https://github.com/Microsoft/AzureMonitorAddonForSplunk).</span></span> <span data-ttu-id="0df28-178">Confira instruções detalhadas em [Instalação](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Installation).</span><span class="sxs-lookup"><span data-stu-id="0df28-178">For detailed installation instructions, see [Installation](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Installation).</span></span> <span data-ttu-id="0df28-179">**Somente o Complemento do Azure Monitor para Splunk versão 1.2.9 ou superior é suportado.**</span><span class="sxs-lookup"><span data-stu-id="0df28-179">**Only Azure Monitor Add-on for Splunk version 1.2.9 or higher is supported.**</span></span>
3. <span data-ttu-id="0df28-180">Depois de instalar o complemento, siga as etapas de configuração descritas em [Wiki de configuração de complementos do Azure Monitor](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Configuration-of-Splunk ) para configurar o Splunk.</span><span class="sxs-lookup"><span data-stu-id="0df28-180">After successfully installing the Add-on, follow the configuration steps described in the [Azure Monitor add-on configuration wiki](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Configuration-of-Splunk ) to configure Splunk.</span></span>
4. <span data-ttu-id="0df28-181">Conforme indicado nas instruções de instalação, o complemento funcionará fazendo um ciclo de habilitar/desabilitar na página Gerenciar aplicativos no Splunk Web.</span><span class="sxs-lookup"><span data-stu-id="0df28-181">As indicated in the Add-on installation instructions, the add-on will work by doing a disable/enable cycle on the Manage Apps page in Splunk Web.</span></span> <span data-ttu-id="0df28-182">Ou reinicie o Splunk.</span><span class="sxs-lookup"><span data-stu-id="0df28-182">Or, you can restart Splunk.</span></span>

## <a name="step-4-register-an-application-with-your-tenant-azure-active-directory-which-splunk-will-use-to-read-from-the-event-hub"></a><span data-ttu-id="0df28-183">Etapa 4: Registrar um aplicativo com o locatário do Active Directory do Azure que o Splunk usará para a leitura do hub de eventos</span><span class="sxs-lookup"><span data-stu-id="0df28-183">Step 4: Register an application with your tenant Azure Active Directory which Splunk will use to read from the event hub</span></span>

<span data-ttu-id="0df28-184">O Splunk precisa de um registro de aplicativo no Active Directory do Azure da sua organização para receber as permissões necessárias e credenciais de aplicativo requeridas para autenticar o hub de evento do Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="0df28-184">Splunk needs an application registration in your organization’s Azure Active Directory to be granted the required permissions and app credentials required to authenticate to the Azure Monitor event hub.</span></span>

1. <span data-ttu-id="0df28-185">No portal do Azure, acesse **Registro de aplicativos** e selecione **Novo registro de aplicativo**.</span><span class="sxs-lookup"><span data-stu-id="0df28-185">In the Azure portal, go to **App Registrations** and select **New application registration**.</span></span>

    ![imagem de Registros de aplicativos](../concepts/images/app-registration.png)

2. <span data-ttu-id="0df28-187">Selecione um nome para o aplicativo, escolha **Web app / API** como tipo e **`http://localhost`** como URL de logon.</span><span class="sxs-lookup"><span data-stu-id="0df28-187">Select a name for your application, choose **Web app / API** for the type, and **`http://localhost`** for the sign-on URL.</span></span> <span data-ttu-id="0df28-188">Selecione **Criar**.</span><span class="sxs-lookup"><span data-stu-id="0df28-188">Then select **Create**.</span></span>

    ![web api config](../concepts/images/app-web-config.png)

3. <span data-ttu-id="0df28-190">Após o aplicativo ser criado, copie a **ID do aplicativo** e salve para uso posterior da configuração das entradas de dados do Splunk.</span><span class="sxs-lookup"><span data-stu-id="0df28-190">After the application is created, copy the **Application ID** and save for later use configuring the Splunk data inputs.</span></span> <span data-ttu-id="0df28-191">Depois, vá até as configurações do aplicativo e escolha **Chaves**.</span><span class="sxs-lookup"><span data-stu-id="0df28-191">Then go to the application settings and choose **Keys**.</span></span>

    ![web app id](../concepts/images/app-id.png)

    <span data-ttu-id="0df28-193">Isso permitirá gerar uma nova chave, conhecida como Segredo do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="0df28-193">This will allow you to generate a new key, known as an Application Secret.</span></span> <span data-ttu-id="0df28-194">Após gerado, copie o **Segredo do aplicativo** e salve para uso posterior da configuração das entradas de dados do Splunk.</span><span class="sxs-lookup"><span data-stu-id="0df28-194">After it's generated, copy the **Application Secret** and save for later use configuring the Splunk data inputs.</span></span>

4. <span data-ttu-id="0df28-195">Conceda a função de **Leitor** ao aplicativo na assinatura do Azure que contém o hub de eventos com os alertas de segurança da organização.</span><span class="sxs-lookup"><span data-stu-id="0df28-195">Grant the application the role of **Reader** in the Azure subscription containing the event hub with your organization’s security alerts.</span></span>

    ![add azure sub](../concepts/images/add-azure-sub.png)

    <span data-ttu-id="0df28-197">Selecione a assinatura, escolha **Controle de acesso (IAM)**.</span><span class="sxs-lookup"><span data-stu-id="0df28-197">Select your subscription, choose **Access control (IAM)**.</span></span> <span data-ttu-id="0df28-198">Selecione **Adicionar** para adicionar permissões.</span><span class="sxs-lookup"><span data-stu-id="0df28-198">Select **Add** to add permissions.</span></span> <span data-ttu-id="0df28-199">Selecione o aplicativo e escolha a **Função** de **Leitor** para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="0df28-199">Select your application and choose the **Role** of **Reader** for your application.</span></span>

    ![add reader perms](../concepts/images/add-reader-perms.png)

    <span data-ttu-id="0df28-201">Selecione **Salvar** para adicionar à assinatura as permissões concedidas ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="0df28-201">Select **Save** to add the permissions granted to your application to the subscription.</span></span>

## <a name="step-5-create-an-azure-key-vault-to-store-the-access-key-for-the-event-hub"></a><span data-ttu-id="0df28-202">Etapa 5: criar um Azure Key Vault para armazenar a tecla de acesso do hub de eventos</span><span class="sxs-lookup"><span data-stu-id="0df28-202">Step 5: Create an Azure Key vault to store the access key for the event hub</span></span>

<span data-ttu-id="0df28-203">Os Azure Key Vaults são usados para armazenar segredos como identidades, senhas e certificados para uso em tempo de execução pelos aplicativos.</span><span class="sxs-lookup"><span data-stu-id="0df28-203">Azure key vaults are used to store secrets such as identities, passwords, and certificates for use at runtime by applications.</span></span> <span data-ttu-id="0df28-204">Nesta etapa, você criará um Azure Key Vault para armazenar os segredos necessários para que o Splunk se conecte e leia nos hubs de eventos do Azure que contêm os alertas de segurança da organização.</span><span class="sxs-lookup"><span data-stu-id="0df28-204">In this step you will create an Azure key vault to store the secrets needed for Splunk to connect and read from the Azure event hubs containing your organization’s security alerts.</span></span>

1. <span data-ttu-id="0df28-205">No portal do Azure, acesse **Cofres de chaves** e **Adicionar**.</span><span class="sxs-lookup"><span data-stu-id="0df28-205">In the Azure portal, go to **Key vaults** and select **Add**.</span></span>

    ![add key vaults](../concepts/images/add-key-vaults.png)

2. <span data-ttu-id="0df28-207">Ao criar o novo cofre de chaves, selecione **Políticas de acesso** para adicionar uma nova política de acesso para o aplicativo que você acabou de registrar na Etapa 4.</span><span class="sxs-lookup"><span data-stu-id="0df28-207">When creating the new key vault, select **Access policies** to add a new access policy for the application you just registered in Step 4.</span></span> <span data-ttu-id="0df28-208">Conceder ao aplicativo as permissões de segredo **Get**.</span><span class="sxs-lookup"><span data-stu-id="0df28-208">Grant the **Get** secret permissions to your application.</span></span> <span data-ttu-id="0df28-209">Isso permitirá ao Splunk, atuando como um aplicativo registrado, acessar as chaves (segredos) armazenadas neste Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="0df28-209">This will allow Splunk, acting as the registered application, to access the keys (secrets) stored in this Azure key vault.</span></span>

    ![add access policies](../concepts/images/add-access-policies.png)

    <span data-ttu-id="0df28-211">Selecione **Criar** para concluir a criação do novo Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="0df28-211">Select **Create** to complete the creation of your new Azure key vault.</span></span>

3. <span data-ttu-id="0df28-212">Gere um novo segredo no cofre de chaves para armazenar a tecla de acesso para o namespace do hub de eventos.</span><span class="sxs-lookup"><span data-stu-id="0df28-212">Generate a new secret in your key vault to store the access key to your event hub namespace.</span></span> <span data-ttu-id="0df28-213">Primeiro, pegue a tecla de acesso do namespace do hub de eventos ao abri-lo e selecione **Políticas de acesso compartilhado**.</span><span class="sxs-lookup"><span data-stu-id="0df28-213">First, grab the access key to your event hub namespace by opening your event hub namespace and selecting **Shared access policies**.</span></span> <span data-ttu-id="0df28-214">Selecione a política **RootManageSharedAccessKey** na lista e copie a **Chave primária** da lista.</span><span class="sxs-lookup"><span data-stu-id="0df28-214">Select the **RootManageSharedAccessKey** policy from the list and copy the **Primary Key** from the list.</span></span>

    ![get shared access policies](../concepts/images/get-shared-policies.png)

4. <span data-ttu-id="0df28-216">Abra o cofre de chaves e selecione **Segredos**.</span><span class="sxs-lookup"><span data-stu-id="0df28-216">Open your key vault and select **Secrets**.</span></span> <span data-ttu-id="0df28-217">Escolha **Gerar/Importar** para adicionar um novo segredo ao cofre de chaves.</span><span class="sxs-lookup"><span data-stu-id="0df28-217">Choose **Generate/Import** to add a new secret to the key vault.</span></span> <span data-ttu-id="0df28-218">Cole na **Chave primária** do namespace do hub de eventos **RootManageSharedAccessKey**.</span><span class="sxs-lookup"><span data-stu-id="0df28-218">Paste in the **Primary key** from the event hub namespace **RootManageSharedAccessKey**.</span></span>

    ![generate new secret](../concepts/images/generate-new-secret.png)

5. <span data-ttu-id="0df28-220">Após criado, selecione o segredo e copie a **Versão do segredo** do segredo.</span><span class="sxs-lookup"><span data-stu-id="0df28-220">After it's created, select the secret and copy the **Secret Version** of the secret.</span></span> <span data-ttu-id="0df28-221">Isso será usado mais adiante na Etapa 6 para configurar as entradas de dados do Splunk.</span><span class="sxs-lookup"><span data-stu-id="0df28-221">This will be used later in Step 6 to configure Splunk data inputs.</span></span>

    ![secret version](../concepts/images/secret-version.png)

## <a name="step-6-configure-the-splunk-data-inputs-to-consume-security-alerts-stored-in-the-event-hub"></a><span data-ttu-id="0df28-223">Etapa 6: configurar as entradas de dados do Splunk para o consumo de alertas de segurança armazenados no hub de eventos</span><span class="sxs-lookup"><span data-stu-id="0df28-223">Step 6: Configure the Splunk data inputs to consume security alerts stored in the event hub</span></span>

<span data-ttu-id="0df28-224">A última etapa para concluir o processo de configuração é definir as entradas de dados do Splunk para usar o hub de eventos, o aplicativo e os segredos criados nas etapas anteriores.</span><span class="sxs-lookup"><span data-stu-id="0df28-224">The last step to complete the setup process is to configure Splunk data inputs to utilize the event hub, application, and secrets you created in previous steps.</span></span>

1. <span data-ttu-id="0df28-225">Siga as instruções do tópico [Configuração do Splunk](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Configuration-of-Splunk) para abrir e configurar as entradas de dados do Splunk para o complemento do Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="0df28-225">Follow the instructions in the [Configuration of Splunk](https://github.com/Microsoft/AzureMonitorAddonForSplunk/wiki/Configuration-of-Splunk) topic to open and configure Splunk data inputs for the Azure Monitor Add-on.</span></span> <span data-ttu-id="0df28-226">Vá até **Configurações** e **Entradas de dados**.</span><span class="sxs-lookup"><span data-stu-id="0df28-226">Go to **Settings** and **Data Inputs**.</span></span> <span data-ttu-id="0df28-227">Escolha **Logs de diagnóstico do Azure Monitor**.</span><span class="sxs-lookup"><span data-stu-id="0df28-227">Choose **Azure Monitor Diagnostic Logs**.</span></span>
2. <span data-ttu-id="0df28-228">Selecione **Novo** e insira todos os campos obrigatórios usando os valores obtidos nas etapas anteriores.</span><span class="sxs-lookup"><span data-stu-id="0df28-228">Select **New** and input all the required fields using the values obtained in the previous steps.</span></span> <span data-ttu-id="0df28-229">A imagem a seguir mostra todos os campos obrigatórios usando os valores dos exemplos anteriores deste artigo.</span><span class="sxs-lookup"><span data-stu-id="0df28-229">The following image shows all the required fields using the values from the previous examples in this article.</span></span>

    ![azure monitor fields](../concepts/images/azure-monitor-fields.png)

3. <span data-ttu-id="0df28-231">Selecione **Próximo** e comece a pesquisar os alertas de segurança da sua organização recebidos do Azure Monitor.</span><span class="sxs-lookup"><span data-stu-id="0df28-231">Select **Next** and begin searching your organization’s security alerts ingested from Azure Monitor.</span></span>

## <a name="optional-use-splunk-search-to-explore-data"></a><span data-ttu-id="0df28-232">(Opcional) Use a pesquisa do Splunk para explorar dados</span><span class="sxs-lookup"><span data-stu-id="0df28-232">(Optional) Use Splunk Search to explore data</span></span>

<span data-ttu-id="0df28-233">Depois que você tiver configurado o plug-in do Splunk para o Azure Monitor, sua instância Splunk começará a recuperar eventos do hub de eventos configurado.</span><span class="sxs-lookup"><span data-stu-id="0df28-233">After you have set up the Azure Monitor Splunk plugin, your Splunk instance will start retrieving events from the configured event hub.</span></span> <span data-ttu-id="0df28-234">Por padrão, o Splunk indexará cada propriedade do esquema de alertas de segurança do Microsoft Graph para permitir a pesquisa.</span><span class="sxs-lookup"><span data-stu-id="0df28-234">By default, splunk will index each property of the Microsoft Graph security alert schema to allow searching.</span></span>

<span data-ttu-id="0df28-235">Para pesquisar por alertas de segurança do Microsoft Graph, criar painéis ou definir alertas do Splunk com sua consulta de pesquisa, navegue até aplicativos -> Aplicativo de consultas e relatórios no Splunk.</span><span class="sxs-lookup"><span data-stu-id="0df28-235">To search for Microsoft Graph security alerts, to create dashboards, or to set Splunk alerts with your search query, navigate to apps -> Search & Reporting app in Splunk.</span></span>

<span data-ttu-id="0df28-236">**Exemplos**:</span><span class="sxs-lookup"><span data-stu-id="0df28-236">Examples</span></span><br/>
<span data-ttu-id="0df28-237">Experimente pesquisar alertas de segurança do Graph:</span><span class="sxs-lookup"><span data-stu-id="0df28-237">Try searching Graph Security alerts:</span></span>

- <span data-ttu-id="0df28-238">Digite `sourcetype="amdl:securitygraph:alert"` na barra de pesquisa para obter todos os alertas exibidos pela API de segurança do Graph.</span><span class="sxs-lookup"><span data-stu-id="0df28-238">Type `sourcetype="amdl:securitygraph:alert"` in the search bar to get all alerts surfaced through the graph security API.</span></span> <span data-ttu-id="0df28-239">No lado direito, você verá as propriedades de nível superior do log do Azure Monitor onde os alertas de segurança do Graph estão abaixo do campo de propriedades.</span><span class="sxs-lookup"><span data-stu-id="0df28-239">On the right-hand side, you will see the top-level properties of Azure Monitor log where Graph Security alert is under properties field.</span></span><br/>
- <span data-ttu-id="0df28-240">No painel esquerdo, você verá campos selecionados e campos interessantes.</span><span class="sxs-lookup"><span data-stu-id="0df28-240">On the left pane, you will see selected fields and interesting fields.</span></span> <span data-ttu-id="0df28-241">Você pode usar os campos selecionados para criar painéis ou alertas do Splunk. Também é possível adicionar ou remover campos selecionados clicando neles com o botão direito.</span><span class="sxs-lookup"><span data-stu-id="0df28-241">You can use selected fields to create dashboards or Splunk alerts, you can also add or remove selected fields by right-clicking on the fields.</span></span>  
> <span data-ttu-id="0df28-242">**Observação:** Como mostrado na consulta de pesquisa a seguir, você pode restringir sua pesquisa conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="0df28-242">**Note:** As shown in the following search query, you can restrict your search as needed.</span></span> <span data-ttu-id="0df28-243">No exemplo, filtramos os alertas de segurança do Graph por alertas de severidade alta da Central de Segurança do Azure.</span><span class="sxs-lookup"><span data-stu-id="0df28-243">In the example, we filter the Graph Security Alerts by high severity alerts from Azure Security Center.</span></span> <span data-ttu-id="0df28-244">Usamos também `eventDatetime`, `severity`, `status` e `provider` como campos selecionados que serão exibidos.</span><span class="sxs-lookup"><span data-stu-id="0df28-244">We also used `eventDatetime`, `severity`, `status`, and `provider` as selected fields to be displayed.</span></span> <span data-ttu-id="0df28-245">Para mais termos de pesquisa avançada, consulte [Tutoriais de pesquisa do Splunk](http://docs.splunk.com/Documentation/Splunk/7.1.2/SearchTutorial/WelcometotheSearchTutorial).</span><span class="sxs-lookup"><span data-stu-id="0df28-245">For more advance search terms, see [splunk search tutorials](http://docs.splunk.com/Documentation/Splunk/7.1.2/SearchTutorial/WelcometotheSearchTutorial).</span></span>

 ![splunk_search_query](../concepts/images/splunk_search_query.png)
> <span data-ttu-id="0df28-247">Consulta de pesquisa: `sourcetype="amdl:securitygraph:alert" "properties.vendorInformation.provider"=ASC "properties.severity"=High | rename properties.eventDataTime as eventDateTime properties.severity as severity properties.vendorInformation.provider as provider properties.status as status`</span><span class="sxs-lookup"><span data-stu-id="0df28-247">Search Query`sourcetype="amdl:securitygraph:alert" "properties.vendorInformation.provider"=ASC "properties.severity"=High | rename properties.eventDataTime as eventDateTime properties.severity as severity properties.vendorInformation.provider as provider properties.status as status`</span></span>

<span data-ttu-id="0df28-248">O Splunk também permite várias ações sobre os resultados da pesquisa usando a opção de menu "Salvar como" na parte superior direita da tela.</span><span class="sxs-lookup"><span data-stu-id="0df28-248">Splunk also allows multiple actions on search results using the "Save As" menu option in top right of the screen.</span></span> <span data-ttu-id="0df28-249">Você pode criar relatórios, painéis ou alertas com base em seu filtro de pesquisa.</span><span class="sxs-lookup"><span data-stu-id="0df28-249">You can create Reports, Dashboard Panels, or Alerts based on your search filter.</span></span>
<span data-ttu-id="0df28-250">A seguir está um exemplo de um painel com um fluxo de evento baseado na consulta anterior. Você pode adicionar um link para analisar cada evento acessando mais detalhes no site do Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="0df28-250">Below is an example of a dashboard with an event stream based on the previous query: You can add a drilldown link to each event to further access the details on Microsoft Graph site.</span></span> <span data-ttu-id="0df28-251">Consulte a [Documentação de análise do Splunk](http://docs.splunk.com/Documentation/Splunk/7.1.2/Viz/DrilldownIntro).</span><span class="sxs-lookup"><span data-stu-id="0df28-251">See [Splunk drilldown documentation](http://docs.splunk.com/Documentation/Splunk/7.1.2/Viz/DrilldownIntro).</span></span>

 ![splunk_search_results](../concepts/images/splunk_search_results.png)

<span data-ttu-id="0df28-253">Ou você pode criar um painel, como um gráfico de linha do tempo:</span><span class="sxs-lookup"><span data-stu-id="0df28-253">Or you can create a dashboard as a timeline chart:</span></span>

 ![splunk_search_timeline](../concepts/images/splunk_search_timeline.png)

<span data-ttu-id="0df28-255">Você pode consultar o [Tutorial de pesquisa e relatórios do Splunk](http://docs.splunk.com/Documentation/Splunk/7.1.2/SearchTutorial/WelcometotheSearchTutorial) para obter mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="0df28-255">You can follow [Splunk Search & Report tutorial](http://docs.splunk.com/Documentation/Splunk/7.1.2/SearchTutorial/WelcometotheSearchTutorial) for more details.</span></span>